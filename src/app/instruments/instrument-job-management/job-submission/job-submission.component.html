<div class="container d-flex flex-column gap-2">
  @if (accountService.loggedIn) {
    <form [formGroup]="form" class="d-flex flex-column gap-3 mb-3">
      <div class="form-group">
        <label for="jobName" class="form-label">Job Name <span class="text-danger">*</span></label>
        <input
          id="jobName"
          type="text"
          class="form-control"
          [ngClass]="{'is-invalid': form.controls['job_name'].invalid && form.controls['job_name'].touched}"
          formControlName="job_name"
          placeholder="Enter job name">
        @if (form.controls['job_name'].invalid && form.controls['job_name'].touched) {
          <div class="invalid-feedback">
            Job name is required
          </div>
        }
      </div>
    </form>

    <form [formGroup]="projectForm" class="d-flex flex-column gap-3">
      <div class="form-group">
        @if (!selectedProject) {
          <label for="projectName" class="form-label">Project Name <span class="text-danger">*</span></label>
        } @else {
          <label for="projectName" class="form-label">Project Name</label>
        }
        <div class="input-group">
          <input
            id="projectName"
            type="search"
            class="form-control"
            [ngClass]="{'is-invalid': !selectedProject && projectForm.controls['project_name'].invalid && projectForm.controls['project_name'].touched}"
            formControlName="project_name"
            (selectItem)="onProjectSelected($event)"
            [ngbTypeahead]="searchProjects"
            [resultFormatter]="formatter"
            [inputFormatter]="formatter"
            placeholder="Search for a project...">
          <span class="input-group-text" *ngIf="projectSearchLoading">
        <div class="spinner-border spinner-border-sm" role="status">
          <span class="visually-hidden">Loading projects...</span>
        </div>
      </span>
          <div class="invalid-feedback" *ngIf="!selectedProject && projectForm.controls['project_name'].invalid && projectForm.controls['project_name'].touched">
            Project name is required
          </div>
        </div>
      </div>

      @if (selectedProject) {
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="card-title">
                  <a href="/#/project-editor/{{selectedProject.id}}">{{selectedProject.project_name}}</a>
                </h5>
                <p class="card-text mb-1"><strong>Created at:</strong> {{selectedProject.created_at | date: 'short'}}</p>
                <p class="card-text"><strong>Description:</strong> {{selectedProject.project_description}}</p>
              </div>
              <button
                class="btn btn-sm btn-danger"
                ngbTooltip="Remove from selection"
                (click)="selectedProject = undefined; projectForm.reset()">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      } @else {
        <div class="form-group">
          <label for="projectDescription" class="form-label">
            Project Description <span class="text-danger">*</span>
          </label>
          <textarea
            id="projectDescription"
            class="form-control"
            [ngClass]="{'is-invalid': projectForm.controls['project_description'].invalid && projectForm.controls['project_description'].touched}"
            formControlName="project_description"
            placeholder="Enter project description"
            rows="3"></textarea>
          @if (projectForm.controls['project_description'].invalid && projectForm.controls['project_description'].touched) {
            <div class="invalid-feedback">
              Project description is required
            </div>
          }
        </div>
      }
    </form>
    @if (job) {
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Job Information</h5>
          <p>
            <b>Current status:</b> {{job?.status || 'N/A'}}<br>
            <b>Owner:</b> {{job?.user?.username || 'N/A'}}
          </p>

          <form [formGroup]="fundingForm" class="d-flex gap-2 flex-wrap">
            <div class="form-group">
              <label for="costCenter">Cost Centre</label>
              <input id="costCenter" (focus)="currentField='cost_center'" type="text"
                     class="form-control" formControlName="cost_center"
                     [ngbTypeahead]="individualFieldSearchValue">
            </div>
            <div class="form-group">
              <label for="funder">Funder</label>
              <input id="funder" (focus)="currentField='funder'" type="text"
                     class="form-control" formControlName="funder"
                     [ngbTypeahead]="individualFieldSearchValue">
            </div>
          </form>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Job Submission To</h5>
          <form [formGroup]="labGroupForm">
            <fieldset>
              <legend class="h6">Facility Group</legend>
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="groupSearch">Group Name Search</label>
                    <input id="groupSearch" formControlName="name" class="form-control" type="search"
                           aria-describedby="groupSearchHelp">
                    <small id="groupSearchHelp" class="form-text text-muted">Search for a group name (defaults to "MS Facility")</small>
                  </div>
                </div>

                @if (labGroupQuery) {
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="groupSelect">Select Group <span class="text-danger">*</span></label>
                      <select id="groupSelect" class="form-select" size="5" formControlName="selected"
                              [ngClass]="{'is-invalid': !job?.service_lab_group}"
                              aria-describedby="groupSelectHelp">
                        @for (group of labGroupQuery.results; track group.id) {
                          <option [value]="group.id">{{group.name}}</option>
                        }
                      </select>
                      <small id="groupSelectHelp" class="form-text text-muted">Select a group to submit the job to (required)</small>
                      @if (selectedGroup) {
                        <div class="mt-2 text-success">
                          <i class="bi bi-check-circle-fill me-1"></i> <b>Currently selected: {{selectedGroup.name}}</b>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            </fieldset>
          </form>

          @if (labGroupUserQuery) {
            <form [formGroup]="form" class="mt-3">
              <fieldset>
                <legend class="h6">Facility Staff</legend>
                <div class="form-group">
                  <label for="staffSelect">Select Staff Members</label>
                  <select id="staffSelect" class="form-select" multiple formControlName="staff"
                          aria-describedby="staffSelectHelp">
                    @for (user of labGroupUserQuery.results; track user.id) {
                      <option [value]="user.id">{{user.username}}</option>
                    }
                  </select>
                  <small id="staffSelectHelp" class="form-text text-muted">Select the staff members to notify</small>
                </div>
              </fieldset>
            </form>
          }

          @if (job && !job.service_lab_group) {
            <ngb-alert type="warning" class="mt-3">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              Please confirm the professional group that would handle this job after submission by selecting a lab group
              and optionally select the user(s) that you are submitting the job to.
            </ngb-alert>
          }
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">Sample Details</h5>
        </div>
        <div class="card-body">
          <!-- Reagent information -->
          <form [formGroup]="reagentForm" class="mb-3">
            @if (selectedStoredReagent) {
              <div class="card border-light">
                <div class="card-body py-2">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="fw-bold mb-1">{{selectedStoredReagent.reagent.name}}</h6>
                      <p class="mb-1"><span class="fw-medium">Quantity:</span> {{selectedStoredReagent.quantity}} {{selectedStoredReagent.reagent.unit}}</p>
                      <p class="mb-0"><span class="fw-medium">Note:</span> {{selectedStoredReagent.notes || 'No notes provided'}}</p>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" ngbTooltip="Remove from selection" (click)="selectedStoredReagent = undefined; reagentForm.reset()">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            }
          </form>

          <!-- Sample number input -->
          <form [formGroup]="formSampleExtraData" class="mb-3">
            <div class="d-flex gap-3 align-items-start">
              <div class="form-group flex-grow-1" style="max-width: 250px">
                <label for="sampleNumber" class="form-label">Sample Number <span class="text-danger">*</span></label>
                <input
                  id="sampleNumber"
                  type="number"
                  class="form-control"
                  formControlName="sample_number"
                  aria-describedby="sampleNumberHelp"
                  min="1">
                <small id="sampleNumberHelp" class="form-text text-muted">Number of samples to process</small>
              </div>
              @if (job.sample_number === 0 || !job.sample_number) {
                <ngb-alert type="warning" class="mb-0 flex-grow-1">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>
                  Please provide a sample number greater than 0 then update the form
                </ngb-alert>
              }
            </div>
          </form>

          <!-- Template selection -->
          @if (job.service_lab_group && job.sample_number > 0) {
            <hr>
            @if (!job.selected_template) {
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0"><span class="badge bg-secondary me-2">Required</span> Job Template</h6>
                  <span class="text-danger">Not selected</span>
                </div>

                <ul ngbNav #templateSelectionNav="ngbNav" class="nav-tabs" [destroyOnHide]="true">
                  @if (job.service_lab_group) {
                    <li [ngbNavItem]="'service_lab_group'">
                      <button ngbNavLink>
                        <i class="bi bi-collection me-1"></i> Group Templates
                      </button>
                      <ng-template ngbNavContent>
                        @if (job.service_lab_group.id) {
                          <app-metadata-template-selection
                            (selected)="handleSelectedTemplate($event)"
                            [lab_group_id]="job.service_lab_group.id">
                          </app-metadata-template-selection>
                        }
                      </ng-template>
                    </li>
                  }
                  <li [ngbNavItem]="'user'">
                    <button ngbNavLink>
                      <i class="bi bi-person-circle me-1"></i> Personal Templates
                    </button>
                    <ng-template ngbNavContent>
                      <app-metadata-template-selection
                        (selected)="handleSelectedTemplate($event)"
                        [lab_group_id]="0">
                      </app-metadata-template-selection>
                    </ng-template>
                  </li>
                </ul>
                <div [ngbNavOutlet]="templateSelectionNav" class="mt-3"></div>

                <ngb-alert type="warning" class="mt-3">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>
                  Please select one of the provided job templates to proceed
                </ngb-alert>
              </div>
            } @else {

              <div class="d-flex align-items-center gap-2">
                <span class="fw-medium">Template:</span>
                @if (job.selected_template) {
                  <span>{{job.selected_template.name}}</span>
                } @else {
                  <span>Not selected</span>
                }
                <button
                  class="btn btn-sm btn-outline-danger ms-2"
                  ngbTooltip="Remove selected template"
                  (click)="removeSelectedTemplate()">
                  <i class="bi bi-trash2"></i>
                </button>
              </div>
            }
          }
        </div>
      </div>
      @if (job.selected_template) {

        <div class="d-flex flex-wrap gap-2">
          <!-- Excel Template Controls -->
          <div ngbDropdown class="d-inline-block">
            <button class="btn btn-outline-primary" ngbDropdownToggle>
              <i class="bi bi-file-earmark-excel me-1"></i> Excel Template
            </button>
            <div ngbDropdownMenu>
              <button ngbDropdownItem (click)="exportExcelTemplate()">
                <i class="bi bi-download me-2"></i> Export Template
              </button>
              @if (job?.status !== 'submitted' || (userCanEdit || staffModeAvailable)) {
                <button ngbDropdownItem (click)="importExcelTemplate()">
                  <i class="bi bi-upload me-2"></i> Import Data
                </button>
              }
            </div>
          </div>

          <!-- Instrument File Controls -->
          @if (userCanEdit || staffModeAvailable) {
            <div ngbDropdown class="d-inline-block">
              <button class="btn btn-outline-secondary" ngbDropdownToggle>
                <i class="bi bi-file-earmark-binary me-1"></i> Instrument Files
              </button>
              <div ngbDropdownMenu>
                <button
                  ngbDropdownItem
                  (click)="exportFile('injection')"
                  [disabled]="!(job?.injection_volume && job?.sample_number && job?.selected_template)"
                  ngbTooltip="Generate randomized injection sequence">
                  <i class="bi bi-shuffle me-2"></i> Randomized Injection
                </button>
              </div>
            </div>
          }

          <!-- SDRF Export Controls -->
          <div ngbDropdown class="d-inline-block">
            <button class="btn btn-outline-success" ngbDropdownToggle>
              <i class="bi bi-download me-1"></i> Export SDRF
            </button>
            <div ngbDropdownMenu>
              <button ngbDropdownItem (click)="exportTableToTSV('user_metadata')">
                <i class="bi bi-person me-2"></i> User Metadata
              </button>
              <button ngbDropdownItem (click)="exportTableToTSV('staff_metadata')">
                <i class="bi bi-people me-2"></i> Staff Metadata
              </button>
              <button ngbDropdownItem (click)="exportTableToTSV('all')">
                <i class="bi bi-files me-2"></i> All Metadata
              </button>
            </div>
          </div>

          <!-- SDRF Import Controls -->
          @if (job?.status !== 'submitted' || (userCanEdit || staffModeAvailable)) {
            <div ngbDropdown class="d-inline-block">
              <button class="btn btn-outline-success" ngbDropdownToggle>
                <i class="bi bi-upload me-1"></i> Import SDRF
              </button>
              <div ngbDropdownMenu>
                <button ngbDropdownItem (click)="importMetadata('user_metadata')">
                  <i class="bi bi-person me-2"></i> User Metadata
                </button>
                <button ngbDropdownItem (click)="importMetadata('staff_metadata')">
                  <i class="bi bi-people me-2"></i> Staff Metadata
                </button>
                <button ngbDropdownItem (click)="importMetadata('all')">
                  <i class="bi bi-files me-2"></i> All Metadata
                </button>
              </div>
            </div>
          }

          <!-- Validation Button -->
          <button class="btn btn-outline-warning" (click)="validateSDRFMetadata()">
            <i class="bi bi-check-circle me-1"></i> Validate Metadata
          </button>
        </div>
        <div class="d-flex flex-wrap gap-2 mt-2">
          <!-- User can edit - User columns dropdown -->
          @if (userCanEdit) {
            <div ngbDropdown display="dynamic" class="d-inline-block">
              <button class="btn btn-primary" ngbDropdownToggle>
                <i class="bi bi-plus-circle me-1"></i> User Columns
              </button>
              <div ngbDropdownMenu aria-labelledby="addMetadata">
                @for (m of metadataService.userMetadataTemplate; track m.name) {
                  <a class="dropdown-item" (click)="addMetadata(m, 'user_metadata')">
                    {{selectedTemplateFieldMap[m.name] || m.name}}
                  </a>
                }
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" (click)="addMetadata({name: 'Sample type', type: 'Characteristics'}, 'user_metadata')">
                  <i class="bi bi-tag me-1"></i> Sample Type
                </a>
                <a class="dropdown-item" (click)="addMetadata({name: '', type: ''}, 'user_metadata')">
                  <i class="bi bi-plus-square me-1"></i> Custom Metadata
                </a>
              </div>
            </div>
          }

          <!-- Staff mode - Additional controls -->
          @if (staffModeAvailable) {
            <!-- Only show this dropdown if job is submitted -->
            @if (job?.status === "submitted") {
              <div ngbDropdown display="dynamic" class="d-inline-block">
                <button class="btn btn-primary" ngbDropdownToggle>
                  <i class="bi bi-plus-circle me-1"></i> User Columns
                </button>
                <div ngbDropdownMenu aria-labelledby="addMetadata">
                  @for (m of metadataService.userMetadataTemplate; track m.name) {
                    <a class="dropdown-item" (click)="addMetadata(m, 'user_metadata')">
                      {{selectedTemplateFieldMap[m.name] || m.name}}
                    </a>
                  }
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" (click)="addMetadata({name: 'Sample type', type: 'Characteristics'}, 'user_metadata')">
                    <i class="bi bi-tag me-1"></i> Sample Type
                  </a>
                  <a class="dropdown-item" (click)="addMetadata({name: '', type: ''}, 'user_metadata')">
                    <i class="bi bi-plus-square me-1"></i> Custom Metadata
                  </a>
                </div>
              </div>
            }

            <!-- Staff columns dropdown - always available in staff mode -->
            <div ngbDropdown display="dynamic" class="d-inline-block">
              <button class="btn btn-warning" ngbDropdownToggle>
                <i class="bi bi-plus-circle me-1"></i> Staff Columns
              </button>
              <div ngbDropdownMenu aria-labelledby="addStaffMetadata">
                @for (m of metadataService.staffMetadataSpecific; track m) {
                  <a class="dropdown-item" (click)="addMetadata({name: m, type: 'Comment'}, 'staff_metadata')">
                    {{selectedTemplateFieldMap[m] || m}}
                  </a>
                }
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" (click)="addMetadata({name: '', type: 'Factor value'}, 'staff_metadata')">
                  <i class="bi bi-diagram-3 me-1"></i> Factor Value
                </a>
                <a class="dropdown-item" (click)="addMetadata({name: '', type: ''}, 'staff_metadata')">
                  <i class="bi bi-plus-square me-1"></i> Custom Metadata
                </a>
              </div>
            </div>
          }
        </div>

        <!-- Show/hide columns toggle -->
        <div class="form-check mt-2">
          <input type="checkbox" class="form-check-input" [(ngModel)]="showHidden" id="showHidden">
          <label class="form-check-label" for="showHidden">
            <i class="bi bi-eye me-1"></i> Show hidden columns
          </label>
        </div>
        @if ((job.user_metadata.length > 0||job.staff_metadata.length > 0) && job.sample_number > 0) {
          <ul ngbNav #navMetadata="ngbNav" class="nav-tabs" [(activeId)]="metadataViewModeID" [destroyOnHide]="true">
            <li [ngbNavItem]="'table'">
              <button ngbNavLink>Table View</button>
              <ng-template ngbNavContent>
                <div class="d-flex flex-column gap-2">

                  <div class="form-floating">
                    <input id="searchMetadata" class="form-control" type="search" [(ngModel)]="filterTableColumnName">
                    <label for="searchMetadata">Search Metadata Column Name</label>
                  </div>
                  <div class="metadata-table-container">
                    @if (job.service_lab_group) {
                      <app-metadata-table [template]="job.selected_template" [showHidden]="showHidden" [service_lab_group_id]="job.service_lab_group.id" (metadataFavouriteAdded)="handleFavouriteAdded($event)" [filterTableColumnName]="filterTableColumnName" (removeMetadata)="removeMetadata($event.index, $event.data_type)" #metadataTable (metadataUpdated)="handleMetadataUpdated($event)" [userCanEdit]="userCanEdit" [sampleNumber]="job.sample_number" [userMetadata]="job.user_metadata" [staffMetadata]="job.staff_metadata" [staffModeActive]="staffModeAvailable"></app-metadata-table>
                    }
                  </div>
                </div>
              </ng-template>
            </li>
            <li [ngbNavItem]="'list'">
              <button ngbNavLink>List View</button>
              <ng-template ngbNavContent>
                <div [formGroup]="metadata">
                  <div [formArrayName]="'user_metadata'" class="d-flex gap-2 flex-column">
                    @for (i of metadata.controls['user_metadata'].controls; track i; let index = $index) {
                      <form [formGroupName]="index" class="d-flex gap-2">
                        <div class="form-group" style="width:400px">
                          <label>{{i.value['name']}}</label>
                          <div class="d-flex gap-2">
                            @if (i.value['name']==='Modification parameters') {
                              <input readonly (focus)="setCurrentForm(i)" type="search" [ngbTypeahead]="searchValue" class="form-control" [formControl]="metadata.controls['user_metadata'].controls[index].controls['value']">
                              <button class="btn btn-sm btn-primary" (click)="editMetadata(index, 'user_metadata')"><i class="bi bi-pen"></i></button>
                            } @else {
                              <input (focus)="setCurrentForm(i)" type="search" [ngbTypeahead]="searchValue" class="form-control" [formControl]="metadata.controls['user_metadata'].controls[index].controls['value']">
                            }
                            @if (!i.value['mandatory']) {
                              <button class="btn btn-sm btn-danger" (click)="removeMetadata(index, 'user_metadata')" ngbTooltip="Remove this metadata"><i class="bi bi-trash2"></i></button>
                            }
                            <button class="btn btn-sm btn-info" (click)="addMetadataModifier(index, 'user_metadata')" ngbTooltip="Add modifier for different sample carrying this metadata"><i class="bi bi-signpost-split"></i></button>
                            @if (i.value['name'] && i.value['type'] && i.value['value']) {
                              <button class="btn btn-sm btn-warning" (click)="addToFavourite(i.value['name'], i.value['type'], i.value['value'])" ngbTooltip="Favourite"><i class="bi bi-star"></i></button>
                            }
                          </div>
                          @if (i.value['name']==='Modification parameters' && i.value['value']) {
                            <app-display-modification-parameters-metadata [value]="i.value['value']"></app-display-modification-parameters-metadata>
                          }
                        </div>
                      </form>
                      @if (i.value['modifiers']) {
                        @if (i.value['modifiers'].length > 0) {
                          <div>
                            <table class="table table-striped table-hover">
                              <thead>
                              <tr>
                                <th scope="col">
                                  Value
                                </th>
                                <th scope="col">
                                  Samples
                                </th>
                                <th scope="col">
                                  Actions
                                </th>
                              </tr>
                              </thead>
                              <tbody>
                                @for (modifier of i.value['modifiers']; track $index; let indexM = $index) {
                                  <tr>
                                    <td>{{modifier['value']}}</td>
                                    <td>{{modifier['samples']}}</td>
                                    <td>
                                      <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-danger" (click)="removeMetadataModifier(index, indexM, 'user_metadata')" ngbTooltip="Remove modifier">
                                          <i class="bi bi-trash2"></i>
                                        </button>
                                        <button class="btn btn-sm btn-primary" (click)="editMetadataModifier(index, indexM, 'user_metadata')" ngbTooltip="Edit modifier">
                                          <i class="bi bi-pencil-fill"></i>
                                        </button>
                                        @if (i.value['name'] && i.value['type'] && modifier['value']) {
                                          <button class="btn btn-sm btn-warning" (click)="addToFavourite(i.value['name'], i.value['type'], modifier['value'])" ngbTooltip="Favourite"><i class="bi bi-star"></i></button>
                                        }
                                      </div>
                                    </td>
                                  </tr>
                                }
                              </tbody>
                            </table>
                          </div>
                        }
                      }
                    }
                  </div>
                </div>
              </ng-template>
            </li>
          </ul>
          <div [ngbNavOutlet]="navMetadata" class="mt-2"></div>
        }
      }
      <hr>
      <h5>MS Experiment Details (for staff)</h5>
      @if (job.staff_metadata.length > 0 && job.sample_number > 0) {
        @if (metadataViewModeID === 'list') {
          <div [formGroup]="metadata">
            <div [formArrayName]="'staff_metadata'" class="d-flex gap-2 flex-column">
              @for (i of metadata.controls['staff_metadata'].controls; track i; let index = $index) {
                <form [formGroupName]="index" class="d-flex gap-2">
                  <div class="form-group" style="width:400px">
                    <label>{{i.value['name']}}</label>
                    <div class="d-flex gap-2">
                      @if (i.value['name']==='Modification parameters') {
                        <input readonly (focus)="setCurrentForm(i)" type="search" [ngbTypeahead]="searchValue" class="form-control" [formControl]="metadata.controls['staff_metadata'].controls[index].controls['value']">
                        <button [disabled]="!staffModeAvailable" class="btn btn-sm btn-primary" (click)="editMetadata(index, 'staff_metadata')"><i class="bi bi-pen"></i></button>
                      } @else {
                        <input [readOnly]="!staffModeAvailable" (focus)="setCurrentForm(i)" type="search" [ngbTypeahead]="searchValue" class="form-control" [formControl]="metadata.controls['staff_metadata'].controls[index].controls['value']">
                      }
                      @if (!i.value['mandatory']) {
                        <button class="btn btn-sm btn-danger" (click)="removeMetadata(index, 'staff_metadata')"><i class="bi bi-trash2"></i></button>
                      }
                      <button class="btn btn-sm btn-info" (click)="addMetadataModifier(index, 'staff_metadata')" ngbTooltip="Add modifier for different sample carrying this metadata"><i class="bi bi-signpost-split"></i></button>
                      @if (i.value['name'] && i.value['type'] && i.value['value']) {
                        <button class="btn btn-sm btn-warning" (click)="addToFavourite(i.value['name'], i.value['type'], i.value['value'])" ngbTooltip="Favourite"><i class="bi bi-star"></i></button>
                      }
                    </div>
                    @if (i.value['name']==='Modification parameters' && i.value['value']) {
                      <app-display-modification-parameters-metadata [value]="i.value['value']"></app-display-modification-parameters-metadata>
                    }
                  </div>
                </form>
                @if (i.value['modifiers']) {
                  @if (i.value['modifiers'].length > 0) {
                    <div>
                      <table class="table table-striped table-hover">
                        <thead>
                        <tr>
                          <th scope="col">
                            Value
                          </th>
                          <th scope="col">
                            Samples
                          </th>
                          <th scope="col">
                            Actions
                          </th>
                        </tr>
                        </thead>
                        <tbody>
                          @for (modifier of i.value['modifiers']; track $index; let indexM = $index) {
                            <tr>
                              <td>{{modifier['value']}}</td>
                              <td>{{modifier['samples']}}</td>
                              <td>
                                <div class="d-flex gap-2">
                                  <button class="btn btn-sm btn-danger" (click)="removeMetadataModifier(index, indexM, 'staff_metadata')" ngbTooltip="Remove modifier">
                                    <i class="bi bi-trash2"></i>
                                  </button>
                                  <button class="btn btn-sm btn-primary" (click)="editMetadataModifier(index, indexM, 'staff_metadata')" ngbTooltip="Edit modifier">
                                    <i class="bi bi-pencil-fill"></i>
                                  </button>
                                  @if (i.value['name'] && i.value['type'] && modifier['value']) {
                                    <button class="btn btn-sm btn-warning" (click)="addToFavourite(i.value['name'], i.value['type'], modifier['value'])" ngbTooltip="Favourite"><i class="bi bi-star"></i></button>
                                  }
                                </div>
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  }
                }
              }
            </div>
          </div>
        }
      }
      <div>
        <div class="card">
          <div class="card-body">
            <div  class="d-flex gap-2 flex-column">
              <h5>Method Information</h5>
              @if (!selectedProtocol) {
                <form [formGroup]="protocolForm">
                  <div class="form-group">
                    <label for="protocolTitle">
                      Method Title
                    </label>
                    <div class="d-flex gap-2">
                      <input [inputFormatter]="protocolFormatter" [resultFormatter]="protocolFormatter" id="protocolTitle" style="width: 300px" type="search" [ngbTypeahead]="searchProtocol" class="form-control" formControlName="protocol_title" placeholder="Enter method title" (selectItem)="onProtocolSelected($event)">
                      @if (protocolSearchLoading) {
                        <div class="spinner-border spinner-border-sm" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      }
                    </div>
                  </div>
                </form>
                <form [formGroup]="protocolForm">
                  <div class="d-flex flex-column">
                    <label>Method Description</label>
                    <quill-editor formControlName="protocol_description" [modules]="editorConfig"></quill-editor>
                  </div>
                </form>
              } @else {
                <div>
                  <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-sm btn-danger" ngbTooltip="Remove from selection" (click)="selectedProtocol = undefined; protocolForm.reset()">
                      <i class="bi bi-trash"></i>
                    </button>
                    @if (this.job) {
                      @if (this.job.protocol) {
                        <button class="btn btn-sm btn-primary" ngbTooltip="Import default table from method" (click)="importMetadataFromMethod()">
                          <i class="bi bi-arrow-up-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" ngbTooltip="Export default table to method" (click)="copyMetadataFromMethod()">
                          <i class="bi bi-arrow-down-circle"></i>
                        </button>
                      }
                    }
                  </div>
                  <a (click)="openProtocolBasicInfoEditor()"><b>{{selectedProtocol.protocol_title}}</b></a>
                  <quill-view [content]="selectedProtocol.protocol_description"></quill-view>
                  <div class="d-flex gap-2">
                    @if (selectedProtocol.metadata_columns.length > 0) {
                      @for (m of selectedProtocol.metadata_columns; track m.id) {
                        @if (m.type === "Characteristics") {
                          <span class="badge bg-primary"><i class="bi bi-x-circle" (click)="deleteMetadata(m)"></i>
                            @if (selectedTemplateFieldMap[m.name]){ {{selectedTemplateFieldMap[m.name]}} } @else {{{m.name}}} : {{m.value}}
                          </span>
                        } @else if (m.type === "Comment") {
                          <span class="badge bg-secondary"><i class="bi bi-x-circle" (click)="deleteMetadata(m)"></i>
                            @if (selectedTemplateFieldMap[m.name]){ {{selectedTemplateFieldMap[m.name]}} } @else {{{m.name}}} : {{m.value}}</span>
                        } @else if (m.type === "Factor value") {
                          <span class="badge bg-success"><i class="bi bi-x-circle" (click)="deleteMetadata(m)"></i>
                            @if (selectedTemplateFieldMap[m.name]){ {{selectedTemplateFieldMap[m.name]}} } @else {{{m.name}}} : {{m.value}}</span>
                        } @else {
                          <span class="badge bg-danger"><i class="bi bi-x-circle" (click)="deleteMetadata(m)"></i>
                            @if (selectedTemplateFieldMap[m.name]){ {{selectedTemplateFieldMap[m.name]}} } @else {{{m.name}}} : {{m.value}}</span>
                        }
                      }
                    }
                  </div>


                </div>
              }

            </div>

            <form [formGroup]="staffDataForm" class="d-flex flex-column gap-2">
              <div class="d-flex gap-2">
                <div class="form-group" style="width: 200px">
                  <label for="injection_volume">Injection Volume ({{staffDataForm.value.injection_unit}})</label>
                  <input id="injection_volume" class="form-control" type="number" formControlName="injection_volume">
                </div>
                <!--<div class="form-group" style="width: 200px">
                  <label for="injection_unit">Injection Unit</label>
                  <select id="injection_unit" class="form-select" formControlName="injection_unit">
                    <option value="nL">nL</option>
                    <option value="uL">uL</option>
                    <option value="mL">mL</option>
                  </select>
                </div>-->
              </div>
              <div class="d-flex gap-2">
                <div class="form-group" style="width: 200px">
                  <label for="search_engine">Search Engine</label>
                  <select id="search_engine" class="form-select" formControlName="search_engine">
                    <option value="MaxQuant">MaxQuant</option>
                    <option value="Proteome Discoverer">Proteome Discoverer</option>
                    <option value="Skyline">Skyline</option>
                    <option value="DIANN">DIANN</option>
                    <option value="MSFragger">MSFragger</option>
                    <option value="Fragpipe">Fragpipe</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="form-group" style="width: 200px">
                  <label for="search_engine_version">Search Engine Version</label>
                  <input id="search_engine_version" class="form-control" type="text" formControlName="search_engine_version">
                </div>
              </div>

              <div class="form-group">
                <label for="location">Folder Location</label>
                <input id="location" class="form-control" type="text" formControlName="location">
              </div>
              <div class="form-group">
                <label for="search_details">Search Details</label>
                <textarea id="search_details" class="form-control" formControlName="search_details"></textarea>
              </div>
            </form>
            <!--<p>
              @if (job.injection_volume) {
                <strong>Injection Volume:</strong> {{job.injection_volume}} {{job.injection_unit}}<br>
              }
              @if (job.location) {
                <strong>Location:</strong> {{job.location}} <br>
              }
              @if (job.search_engine) {
                <strong>Search Engine:</strong> {{job.search_engine}} {{job.search_engine_version}}<br>
              }
              @if (job.search_details) {
                <strong>Search Details:</strong><br>
                {{job.search_details}}
              }
            </p>-->
          </div>
        </div>
      </div>
      <hr>

    }
    <div class="d-flex gap-2 mt-2" id="submitUpdateBar">
      @if (!job) {
        <button class="btn btn-primary" (click)="createDraftJob()">Create Job</button>
      } @else {
        <input type="file" hidden #fastaFileUpload (change)="annotationService.handleFileInput($event, job.id, 'user_annotation', 'fasta file from job '+job.job_name, 'file')">

        @if (job.status !== 'submitted' && (userCanEdit || staffModeAvailable)) {
          @if (job.sample_number > 0 && job.selected_template) {
            <button class="btn btn-primary" [disabled]="job.status !== 'draft'" (click)="submit()">Submit</button>
          }
          <button class="btn btn-primary" (click)="update()">Update</button>
          <div>
            <button class="btn btn-primary" (click)="fastaFileUpload.click()"><i class="bi bi-upload"></i> Fasta File</button>
          </div>

          <div ngbDropdown display="dynamic" class="d-inline-black">
            <button class="btn btn-primary" id="addMetadata" ngbDropdownToggle>
              + User Columns
            </button>
            <div ngbDropdownMenu aria-labelledby="addMetadata">
              @for (m of metadataService.userMetadataTemplate; track m.name) {
                <a class="dropdown-item" (click)="addMetadata(m, 'user_metadata')">
                  @if (selectedTemplateFieldMap[m.name]) {
                    {{selectedTemplateFieldMap[m.name]}}
                  } @else {
                    {{m.name}}
                  }
                </a>
              }
              <a class="dropdown-item" (click)="addMetadata({name: 'Sample type', type: 'Characteristics'}, 'user_metadata')">
                Sample Type
              </a>
              <a class="dropdown-item" (click)="addMetadata({name: '', type: ''}, 'user_metadata')">
                Custom Metadata
              </a>
            </div>
          </div>
        }
        @if (staffModeAvailable) {
          @if (job.status === 'submitted') {
            <div>
              <button class="btn btn-primary" (click)="fastaFileUpload.click()"><i class="bi bi-upload"></i> Fasta File</button>
            </div>
            <button class="btn btn-warning" (click)="update()">Update</button>
            <div ngbDropdown display="dynamic" class="d-inline-black">
              <button class="btn btn-primary" id="addMetadataStaff" ngbDropdownToggle>
                + User Columns
              </button>
              <div ngbDropdownMenu aria-labelledby="addMetadata">
                @for (m of metadataService.userMetadataTemplate; track m.name) {
                  <a class="dropdown-item" (click)="addMetadata(m, 'staff_metadata')">
                    @if (selectedTemplateFieldMap[m.name]) {
                      {{selectedTemplateFieldMap[m.name]}}
                    } @else {
                      {{m.name}}
                    }
                  </a>
                }
                <a class="dropdown-item" (click)="addMetadata({name: 'Sample type', type: 'Characteristics'}, 'user_metadata')">
                  Sample Type
                </a>
                <a class="dropdown-item" (click)="addMetadata({name: '', type: ''}, 'user_metadata')">
                  Custom Metadata
                </a>
              </div>
            </div>
          }
          <div ngbDropdown display="dynamic" class="d-inline-black">
            <button class="btn btn-warning" id="addStaffMetadata" ngbDropdownToggle>
              + Staff Columns
            </button>
            <div ngbDropdownMenu aria-labelledby="addStaffMetadata">
              @for (m of metadataService.staffMetadataSpecific; track m) {
                <a class="dropdown-item" (click)="addMetadata({name: m, type: 'Comment'}, 'staff_metadata')">
                  @if (selectedTemplateFieldMap[m]) {
                    {{selectedTemplateFieldMap[m]}}
                  } @else {
                    {{m}}
                  }
                </a>
              }
              <a class="dropdown-item" (click)="addMetadata({name: '', type: 'Factor value'}, 'staff_metadata')">
                Factor Value
              </a>
              <a class="dropdown-item" (click)="addMetadata({name: '', type: ''}, 'staff_metadata')">
                Custom Metadata
              </a>
            </div>
          </div>
        }
      }

      <a class="btn btn-danger" href="/#/instruments/jobs">New Submission</a>
    </div>

    @if (job) {
      <div class="d-flex flex-column g-2">
        @if (annotationService.audioURL) {
          <div class="d-flex flex-column gap-1">
            <div class="d-flex flex-row justify-content-center">
              <div class="d-flex flex-column">
                <div class="card recording-preview-card">
                  <div class="card-header">
                    <h5 class="card-title">Recording Preview</h5>
                  </div>
                  <div class="card-body">
                    @if (annotationService.clickedInstrumentItem==='Audio') {
                      <audio controls>
                        <source [src]="annotationService.audioURL" type="audio/webm">
                        Your browser does not support the audio element.
                      </audio>
                    } @else if (annotationService.clickedInstrumentItem==='Video') {
                      <video controls [width]="400" [height]="300">
                        <source [src]="annotationService.audioURL" type="video/webm">
                        Your browser does not support the video element.
                      </video>
                    }
                  </div>
                </div>
              </div>

            </div>
            <div class="d-flex flex-row gap-2">
              <button class="btn btn-primary" (click)="annotationService.saveRecording(job.id, 'user_annotation')">Save</button>
              <button class="btn btn-danger" (click)="annotationService.deletePreviewRecording()">Delete</button>

            </div>
          </div>
        }
      </div>
      <div class="p-2" id="annotationCreator">
        @if (this.annotationService.clickedInstrumentItem==='Text') {
          <app-annotation-text-form (text)="this.annotationService.handleTextAnnotation($event, job.id, 'user_annotation')"></app-annotation-text-form>
        } @else if (this.annotationService.clickedInstrumentItem==='Sketchpad') {
          <app-handwritten-annotation (sketch)="this.annotationService.handleSketchAnnotation($event, job.id, 'user_annotation')"></app-handwritten-annotation>
        } @else if (this.annotationService.clickedInstrumentItem==='File') {
          <div class="form-group">
            <label for="file">Upload File</label>
            <input type="file" class="form-control" id="file" (change)="this.annotationService.handleFileInput($event, job.id, 'user_annotation')">
          </div>
        } @else if (this.annotationService.clickedInstrumentItem==='Audio') {
          <div class="d-flex flex-row gap-2 flex-wrap">
            @if (this.annotationService.recording) {
              <button class="btn btn-danger" (click)="this.annotationService.stopRecording()">Stop Recording</button>
            } @else {
              <button class="btn btn-primary" (click)="this.annotationService.startRecording(true, false)">Start Recording</button>
            }

            <div class="form-floating">
              <select class="form-select" [(ngModel)]="this.annotationService.currentAudioDevice" >
                <option selected [value]="null">Default Selected</option>
                @for (a of this.annotationService.audioDevices; track a) {
                  <option [ngValue]="a">{{a.label}}</option>
                }
              </select>
              <label>Select Audio Device</label>
            </div>
            <canvas id="visualizer" width="200" height="50"></canvas>
          </div>

        } @else if (annotationService.clickedInstrumentItem==='Video') {
          <div class="container">
            <div class="d-flex flex-column gap-2">
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title">Video Preview</h5>
                </div>
                <div class="d-flex flex-row justify-content-center">
                  <video id="previewVideo" autoplay muted #previewVideo [width]="400" [height]="300"></video>
                </div>
                <canvas id="visualizer" width="200" height="50"></canvas>
              </div>


              <div class="d-flex flex-row gap-2">
                @if (annotationService.recording) {
                  <button class="btn btn-danger" (click)="annotationService.stopRecording()">Stop Recording</button>
                } @else {
                  <button class="btn btn-primary" (click)="annotationService.startRecording(enableAudio.checked, enableVideo.checked)">Record Video</button>
                  <button class="btn btn-primary" (click)="annotationService.startScreenRecording(enableAudio.checked)">Record Screen</button>
                }
              </div>
              <div class="d-flex flex-row gap-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" #enableVideo [(ngModel)]="annotationService.enableVideo">
                  <label class="form-check-label">Enable Video</label>
                </div>
                @if (annotationService.enableVideo) {
                  <div class="form-floating">
                    <select class="form-select" [(ngModel)]="annotationService.currentCameraDevice">
                      <option selected>Default Selected</option>
                      @for (a of annotationService.cameraDevices; track a) {
                        <option [ngValue]="a">{{a.label}}</option>
                      }
                    </select>
                    <label>Select Camera Device</label>
                  </div>
                }
              </div>
              <div class="d-flex flex-row gap-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" #enableAudio [(ngModel)]="annotationService.enableAudio">
                  <label class="form-check-label">Enable Audio</label>
                </div>
                @if (annotationService.enableAudio) {
                  <div class="form-floating">
                    <select class="form-select" [(ngModel)]="this.annotationService.currentAudioDevice">
                      <option selected>Default Selected</option>
                      @for (a of this.annotationService.audioDevices; track a) {
                        <option [ngValue]="a">{{a.label}}</option>
                      }
                    </select>
                    <label>Select Audio Device</label>
                  </div>
                }
              </div>
            </div>
            @if (this.annotationService.recording && !this.annotationService.screenRecording) {

            }
          </div>

        } @else if (this.annotationService.clickedInstrumentItem==='Image') {
          <div class="form-group">
            <label for="image">Upload Image</label>
            <input type="file" class="form-control" id="image" (change)="this.annotationService.handleFileInput($event, job.id, 'user_annotation')">
          </div>
        } @else if (this.annotationService.clickedInstrumentItem === 'Alignment') {
          <div class="form-group">
            <label for="file">Upload Alignment</label>
            <input type="file" class="form-control" id="alignment-file" (change)="this.annotationService.handleFileInput($event, job.id, 'user_annotation')">
          </div>
        }
      </div>
      @if (job.user_annotations || job.staff_annotations) {
        <ul ngbNav #nav="ngbNav" [(activeId)]="activeTab" class="nav-tabs"  [destroyOnHide]="true">
          <li [ngbNavItem]="'user'">
            <button ngbNavLink>User Annotations</button>
            <ng-template ngbNavContent>
              @if (activeTab === 'user') {
                <app-annotation-presenter [annotations]="job.user_annotations" (deleteAnnotation)="handleDeleteAnnotation($event)"></app-annotation-presenter>
              }
            </ng-template>
          </li>
          @if (staffModeAvailable) {
            <li [ngbNavItem]="'staff'">
              <button ngbNavLink>Staff Annotations</button>
              <ng-template ngbNavContent>
                <app-annotation-presenter [annotations]="job.staff_annotations" (deleteAnnotation)="handleDeleteAnnotation($event)"></app-annotation-presenter>
              </ng-template>
            </li>
          }

        </ul>
        <div [ngbNavOutlet]="nav" class="mt-2"></div>
        <div style="position: fixed; z-index: 1030; bottom: 50px; right: 50px">
          <div class="d-flex flex-row gap-2 align-items-center">
            @if (staffModeAvailable) {
              <button class="btn btn-warning" (click)="openStaffDataEntryPanel()">Staff</button>
              <button class="btn btn-danger" (click)="annotationService.annotationInstrumentMenuClick('Instrument', 'staff_annotation', job.id)">Book Instrument</button>
            }
            <div ngbDropdown placement="top-end" class="d-inline-block">
              <button class="btn btn-outline-success" ngbDropdownToggle><i class="bi bi-plus"></i></button>
              <div ngbDropdownMenu>
                @if (job) {
                  @for (a of ['Audio', 'Text', 'Video', 'Image', 'Sketchpad', 'Counter','File', 'Checklist', 'Table', 'Alignment', 'Calculator', 'Molarity Calculator', 'Randomization', 'Large/Multiple Files']; track a) {
                    @if (staffModeAvailable) {
                      <button ngbDropdownItem (click)="annotationService.annotationInstrumentMenuClick(a, 'staff_annotation', job.id)">{{a}}</button>
                    } @else {
                      <button ngbDropdownItem (click)="annotationService.annotationInstrumentMenuClick(a, 'user_annotation', job.id)">{{a}}</button>
                    }

                  }
                }
              </div>
            </div>
          </div>
        </div>
      }
    }
  } @else {
    <ngb-alert type="danger">
      Job Submission Required User To Be Logged In.
    </ngb-alert>
  }

</div>

