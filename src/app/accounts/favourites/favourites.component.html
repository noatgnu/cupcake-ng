<div class="container">
  <div class="d-flex flex-column gap-2">
    <div ngbDropdown>
      <button class="btn btn-primary" ngbDropdownToggle>
        <i class="bi bi-plus"></i> Add Favourite
      </button>
      <div ngbDropdownMenu>
        @for (f of metadata.userMetadataTemplate; track $index) {
          <button class="dropdown-item" (click)="createFavourite(f.name, f.type)">{{f.name}}</button>
        }
        @for (f of metadata.staffMetadataSpecific; track $index) {
          <button class="dropdown-item" (click)="createFavourite(f, 'Comment')">{{f}}</button>
        }
      </div>
    </div>
    @if (favouriteQuery) {
      <table class="table table-hover">
        <thead>
        <tr>
          <th scope="col">ID</th>
          <th scope="col">Data type</th>
          <th scope="col">Data name</th>
          <th scope="col">Display name</th>
          <th scope="col">Value</th>
          <th scope="col">Professional Lab group</th>
          <th scope="col">User</th>
          <th scope="col">Global</th>
          <th scope="col">Actions</th>
        </tr>
        </thead>
        <tbody>
          @for (f of favouriteQuery.results; track f.id) {
            <tr>
              <td>
                {{f.id}}
              </td>
              <td>{{f.type}}</td>
              <td>{{f.name}}</td>
              <td (mouseenter)="currentCell = {row: f.id, col: 'display_value'}">
                @if (editableCell && editableCell?.row === f.id && editableCell?.col === 'display_value') {
                  <input [(ngModel)]="f.display_value" class="form-control" (blur)="saveEditableCell(f, 'display_value')">
                } @else {
                  {{f.display_value}} @if (currentCell && (currentCell?.row === f.id && currentCell?.col === 'display_value')) {
                    <div ngbDropdown>
                      <i class="bi bi-pencil-fill" id="favouriteDropdownDisplayValue" ngbDropdownToggle></i>
                      <div ngbDropdownMenu aria-labelledby="favouriteDropdownDisplayValue">
                        <button class="dropdown-item" (click)="toggleEditableCell(f.id, 'display_value')">Direct Edit Display Name</button>

                      </div>
                    </div>
                  }
                }
              </td>
              <td (mouseover)="currentCell = {row: f.id, col: 'value'}">
                @if (editableCell && editableCell?.row === f.id && editableCell?.col === 'value') {
                  <input [(ngModel)]="f.value" class="form-control" (blur)="saveEditableCell(f, 'value')">
                } @else {
                  {{f.value}} @if (currentCell && (currentCell?.row === f.id && currentCell?.col === 'value')) {
                    <div ngbDropdown>
                      <i class="bi bi-pencil-fill" id="favouriteDropdown" ngbDropdownToggle></i>
                      <div ngbDropdownMenu aria-labelledby="favouriteDropdown">
                        <button class="dropdown-item" (click)="toggleEditableCell(f.id, 'value')">Direct Edit Value</button>
                        <button class="dropdown-item" (click)="editFavoriteMetadata(f)">Edit Value Using Data Editor</button>
                      </div>
                    </div>
                  }
                }
              </td>
              <td>
                @if (f.service_lab_group) {
                  @if (labGroupMap[f.service_lab_group]) {
                    {{labGroupMap[f.service_lab_group].name}}
                  }
                }
              </td>
              <td>
                @if (f.user) {
                  @if (userMap[f.user]) {
                    {{userMap[f.user].username}}
                  }
                }
              </td>
              <td>
                @if (accountService.is_staff) {
                  <i class="bi bi-globe" [class.text-success]="f.is_global" [class.text-danger]="!f.is_global" (click)="toggleFavouriteGlobal(f)"></i>
                } @else {
                  <i class="bi bi-globe" [class.text-success]="f.is_global" [class.text-danger]="!f.is_global"></i>
                }

              </td>
              <td>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-danger" (click)="removeFavourite(f.id)" [ngbTooltip]="'Remove Favourite'"><i class="bi bi-trash"></i></button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
      <ngb-pagination (pageChange)="onPageChange($event)" [collectionSize]="favouriteQuery.count" [(page)]="page" [pageSize]="pageSize" [maxSize]="5" [boundaryLinks]="true" [rotate]="true"></ngb-pagination>
    }
  </div>
</div>
