<div class="enhanced-table-presenter">
  <!-- Enhanced Header with Controls -->
  <div class="table-header mb-3">
      <div class="table-header-top">
        <div class="table-info">
          <h5 class="card-title mb-1">{{data.name}}</h5>
          <div class="table-meta">
            <small class="text-muted">
              <i class="bi bi-table me-1"></i>{{getVisibleRows().length}} × {{getColumnCount()}} cells
              @if (getSelectedCellCount() > 0) {
                <span class="mx-2">•</span>
                <i class="bi bi-check-square me-1"></i>{{getSelectedCellCount()}} selected
              }
              @if (hasFilter()) {
                <span class="mx-2">•</span>
                <i class="bi bi-funnel me-1"></i>Filtered
              }
            </small>
          </div>
        </div>
        
        <div class="table-actions">
          <!-- View Mode Toggle -->
          <div class="btn-group btn-group-sm me-2" role="group">
            <input type="radio" class="btn-check" id="viewTable" name="viewMode" 
                   [value]="false" [(ngModel)]="editMode" (change)="toggleEditMode()">
            <label class="btn btn-outline-primary" for="viewTable">
              <i class="bi bi-eye me-1"></i>View
            </label>
            <input type="radio" class="btn-check" id="editTable" name="viewMode" 
                   [value]="true" [(ngModel)]="editMode" (change)="toggleEditMode()">
            <label class="btn btn-outline-primary" for="editTable">
              <i class="bi bi-pencil me-1"></i>Edit
            </label>
          </div>
          
          <!-- Action Dropdown -->
          <div class="btn-group" ngbDropdown container="body">
            <button class="btn btn-primary btn-sm" ngbDropdownToggle>
              <i class="bi bi-gear me-1"></i>Actions
            </button>
            <div class="dropdown-menu" ngbDropdownMenu>
              <h6 class="dropdown-header">Data Operations</h6>
              <button class="dropdown-item" (click)="save()" [disabled]="!hasChanges()">
                <i class="bi bi-floppy me-2"></i>Save Changes
                @if (hasChanges()) {
                  <span class="badge bg-warning ms-auto">{{getChangeCount()}}</span>
                }
              </button>
              <button class="dropdown-item" (click)="exportData()">
                <i class="bi bi-download me-2"></i>Export CSV
              </button>
              <button class="dropdown-item" (click)="exportToJSON()">
                <i class="bi bi-file-code me-2"></i>Export JSON
              </button>
              
              <div class="dropdown-divider"></div>
              <h6 class="dropdown-header">Table Structure</h6>
              <button class="dropdown-item" (click)="addRow()">
                <i class="bi bi-plus-square me-2"></i>Add Row
              </button>
              <button class="dropdown-item" (click)="addColumn()">
                <i class="bi bi-plus-square-dotted me-2"></i>Add Column
              </button>
              <button class="dropdown-item" (click)="deleteSelectedRows()" [disabled]="getSelectedRows().length === 0">
                <i class="bi bi-trash me-2"></i>Delete Selected Rows
                @if (getSelectedRows().length > 0) {
                  <span class="badge bg-danger ms-auto">{{getSelectedRows().length}}</span>
                }
              </button>
              
              <div class="dropdown-divider"></div>
              <h6 class="dropdown-header">Selection</h6>
              <button class="dropdown-item" (click)="selectAll()">
                <i class="bi bi-check-all me-2"></i>Select All
              </button>
              <button class="dropdown-item" (click)="clearSelection()" [disabled]="getSelectedCellCount() === 0">
                <i class="bi bi-x-square me-2"></i>Clear Selection
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tracking and Filter Controls -->
      <div class="table-header-bottom mt-2">
        <div class="row g-2">
          <div class="col-md-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" 
                     id="trackingToggle" [(ngModel)]="data.tracking">
              <label class="form-check-label" for="trackingToggle">
                <i class="bi bi-cursor-fill me-1"></i>Click Tracking
              </label>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="input-group input-group-sm">
              <span class="input-group-text">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" class="form-control" placeholder="Filter table..." 
                     [(ngModel)]="filterText" (input)="applyFilter()">
              @if (filterText) {
                <button class="btn btn-outline-secondary" (click)="clearFilter()" ngbTooltip="Clear filter">
                  <i class="bi bi-x"></i>
                </button>
              }
            </div>
          </div>
          
          <div class="col-md-3">
            <div class="btn-group btn-group-sm w-100" ngbDropdown container="body">
              <button class="btn btn-outline-secondary" ngbDropdownToggle>
                <i class="bi bi-sort-alpha-down me-1"></i>{{getSortLabel()}}
              </button>
              <div class="dropdown-menu" ngbDropdownMenu>
                <button class="dropdown-item" (click)="setSortColumn(-1)" [class.active]="sortColumn === -1">
                  <i class="bi bi-list me-2"></i>Original Order
                </button>
                <div class="dropdown-divider"></div>
                @for (col of getColumnHeaders(); track $index; let i = $index) {
                  <button class="dropdown-item" (click)="setSortColumn(i)" [class.active]="sortColumn === i">
                    <i class="bi" [ngClass]="getSortIcon(i)" [class]="'me-2'"></i>
                    Column {{i + 1}} {{sortColumn === i ? (sortDirection === 'asc' ? '↑' : '↓') : ''}}
                  </button>
                }
              </div>
            </div>
          </div>
          
          <div class="col-md-2">
            <div class="text-center">
              <small class="text-muted">
                @if (hasFilter() || sortColumn !== -1) {
                  <button class="btn btn-sm btn-outline-warning" (click)="resetView()" ngbTooltip="Reset filters and sorting">
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                } @else {
                  <span class="badge bg-success">Default View</span>
                }
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Table Body -->
    <div class="table-body">
      <div class="table-container" [style.max-height.px]="tableMaxHeight">
        @if (getVisibleRows().length > 0) {
          <table class="table table-hover enhanced-table">
            <!-- Column Headers -->
            <thead class="table-header-sticky">
              <tr>
                <th class="selection-header">
                  <div class="header-content">
                    <input type="checkbox" class="form-check-input" 
                           [checked]="isAllRowsSelected()" 
                           [indeterminate]="isSomeRowsSelected()"
                           (change)="toggleAllRows($event)">
                  </div>
                </th>
                @for (header of getColumnHeaders(); track $index; let i = $index) {
                  <th class="column-header" [class.sortable]="true" (click)="toggleSort(i)">
                    <div class="header-content">
                      <div class="header-text">
                        @if (editMode && editingHeaders) {
                          <input type="text" class="form-control form-control-sm" 
                                 [(ngModel)]="columnHeaders[i]" 
                                 placeholder="Column {{i + 1}}">
                        } @else {
                          <span>{{getColumnHeader(i)}}</span>
                        }
                      </div>
                      <div class="header-actions">
                        @if (sortColumn === i) {
                          <i class="bi sort-indicator" [ngClass]="getSortIcon(i)"></i>
                        }
                        <div class="btn-group" ngbDropdown container="body">
                          <button class="btn btn-sm btn-ghost" ngbDropdownToggle ngbTooltip="Column options">
                            <i class="bi bi-three-dots-vertical"></i>
                          </button>
                          <div class="dropdown-menu" ngbDropdownMenu>
                            <button class="dropdown-item" (click)="sortColumn = i; sortDirection = 'asc'; applySorting()">
                              <i class="bi bi-sort-alpha-down me-2"></i>Sort A → Z
                            </button>
                            <button class="dropdown-item" (click)="sortColumn = i; sortDirection = 'desc'; applySorting()">
                              <i class="bi bi-sort-alpha-up me-2"></i>Sort Z → A
                            </button>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item" (click)="selectColumn(i)">
                              <i class="bi bi-check-square me-2"></i>Select Column
                            </button>
                            <button class="dropdown-item text-danger" (click)="deleteColumn(i)" [disabled]="getColumnCount() <= 1">
                              <i class="bi bi-trash me-2"></i>Delete Column
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </th>
                }
                @if (editMode) {
                  <th class="add-column-header">
                    <button class="btn btn-sm btn-outline-primary" (click)="addColumn()" ngbTooltip="Add column">
                      <i class="bi bi-plus"></i>
                    </button>
                  </th>
                }
              </tr>
            </thead>
            
            <!-- Table Rows -->
            <tbody>
              @for (row of getVisibleRows(); track getRowId(row); let iRow = $index) {
                <tr class="table-row" 
                    [class.row-selected]="isRowSelected(row.originalIndex)"
                    [class.row-tracked]="hasTrackedCells(row.originalIndex)">
                  <!-- Row Selection -->
                  <td class="selection-cell">
                    <div class="cell-content">
                      <input type="checkbox" class="form-check-input" 
                             [checked]="isRowSelected(row.originalIndex)"
                             (change)="toggleRowSelection(row.originalIndex)">
                      <div class="row-actions">
                        @if (editMode) {
                          <button class="btn btn-sm btn-ghost" (click)="deleteRow(row.originalIndex)" 
                                  ngbTooltip="Delete row">
                            <i class="bi bi-trash"></i>
                          </button>
                        }
                      </div>
                    </div>
                  </td>
                  
                  <!-- Data Cells -->
                  @for (cell of row.data; track $index; let iCol = $index) {
                    <td class="data-cell" 
                        [class.cell-selected]="isCellSelected(row.originalIndex, iCol)"
                        [class.cell-tracked]="isCellTracked(row.originalIndex, iCol)"
                        [class.cell-changed]="isCellChanged(row.originalIndex, iCol)"
                        (click)="handleCellClick(row.originalIndex, iCol, $event)">
                      <div class="cell-content">
                        @if (editMode) {
                          <input type="text" 
                                 class="form-control cell-input" 
                                 [(ngModel)]="segments[row.originalIndex][iCol]"
                                 (blur)="onCellChange(row.originalIndex, iCol)"
                                 (keydown)="onCellKeyDown($event, row.originalIndex, iCol)"
                                 [placeholder]="getCellPlaceholder(iCol)">
                        } @else {
                          <div class="cell-display" [innerHTML]="formatCellValue(cell, iCol)"></div>
                        }
                        
                        <!-- Cell Status Indicators -->
                        <div class="cell-indicators">
                          @if (isCellTracked(row.originalIndex, iCol)) {
                            <i class="bi bi-check-circle cell-indicator tracked" ngbTooltip="Tracked"></i>
                          }
                          @if (isCellChanged(row.originalIndex, iCol)) {
                            <i class="bi bi-pencil-square cell-indicator changed" ngbTooltip="Modified"></i>
                          }
                        </div>
                      </div>
                    </td>
                  }
                  
                  @if (editMode) {
                    <td class="add-cell">
                      <!-- Spacer for add column button -->
                    </td>
                  }
                </tr>
              }
            </tbody>
          </table>
          
          @if (editMode) {
            <div class="add-row-section">
              <button class="btn btn-outline-primary w-100" (click)="addRow()">
                <i class="bi bi-plus me-2"></i>Add Row
              </button>
            </div>
          }
        } @else {
          <!-- Empty State -->
          <div class="empty-state">
            @if (hasFilter()) {
              <i class="bi bi-search fs-1 text-muted"></i>
              <h6 class="mt-3">No Results Found</h6>
              <p class="text-muted">No rows match your filter criteria.</p>
              <button class="btn btn-outline-primary" (click)="clearFilter()">
                Clear Filter
              </button>
            } @else {
              <i class="bi bi-table fs-1 text-muted"></i>
              <h6 class="mt-3">Empty Table</h6>
              <p class="text-muted">This table doesn't contain any data yet.</p>
              @if (editMode) {
                <button class="btn btn-primary" (click)="addRow()">
                  <i class="bi bi-plus me-2"></i>Add First Row
                </button>
              }
            }
          </div>
        }
      </div>
    </div>

    <!-- Enhanced Footer with Statistics -->
    <div class="table-footer">
      <div class="table-stats">
        <div class="row g-2 text-center">
          <div class="col">
            <div class="stat-item">
              <div class="stat-value">{{getTotalCells()}}</div>
              <div class="stat-label">Total Cells</div>
            </div>
          </div>
          <div class="col">
            <div class="stat-item">
              <div class="stat-value">{{getFilledCells()}}</div>
              <div class="stat-label">Filled</div>
            </div>
          </div>
          <div class="col">
            <div class="stat-item">
              <div class="stat-value">{{getSelectedCellCount()}}</div>
              <div class="stat-label">Selected</div>
            </div>
          </div>
          <div class="col">
            <div class="stat-item">
              <div class="stat-value">{{getLastModified()}}</div>
              <div class="stat-label">Last Modified</div>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>
