<div class="container-fluid p-0">
  <div class="d-flex g-1" style="height: 86vh; position:relative">
    @if (showSection) {
      <div class="border-end border-1 border-black d-flex flex-column h-100" style="max-width: 300px">
        <nav class="navbar navbar-expand-lg navbar-light d-flex flex-wrap">
          <div class="container-fluid">
            <a class="navbar-brand">Sections</a>
          </div>
        </nav>
        <div class="list-group d-flex flex-column rounded-0 overflow-auto">
          @for (s of sections; track s.data.id) {
            @if (currentSection) {
              @if (currentSection.data.id === s.data.id) {
                <div class="list-group-item list-group-item-primary list-group-item-action" (click)="handleSectionClick(s)">
                  <p>{{s.data.section_description}}</p>
                  Duration: {{timer.convertTime(s.data.section_duration)}}
                  <ul>
                    @for (step of s.steps; track step.id; let i=$index) {
                      @if (timer.currentTrackingStep.includes(step.id)) {
                        <li>{{i+1}}/{{s.steps.length}}: {{timer.convertTime(timer.timeKeeper[step.id.toString()].current)}}/{{timer.convertTime(step.step_duration)}}</li>
                      }
                    }
                  </ul>
                </div>
              } @else {
                <div class="list-group-item list-group-item-action" (click)="handleSectionClick(s)">
                  <p>{{s.data.section_description}}</p>
                  Duration: {{timer.convertTime(s.data.section_duration)}}
                  <ul>
                    @for (step of s.steps; track step.id; let i=$index) {
                      @if (timer.currentTrackingStep.includes(step.id)) {
                        <li>{{i+1}}/{{s.steps.length}}: {{timer.convertTime(timer.timeKeeper[step.id.toString()].current)}}/{{timer.convertTime(step.step_duration)}}</li>
                      }
                    }
                  </ul>
                </div>
              }
            } @else {
              <div class="list-group-item list-group-item-action" (click)="handleSectionClick(s)">
                <p>{{s.data.section_description}}</p>
                Duration: {{timer.convertTime(s.data.section_duration)}}
                <ul>
                  @for (step of s.steps; track step.id; let i=$index) {
                    @if (timer.currentTrackingStep.includes(step.id)) {
                      <li>{{i+1}}/{{s.steps.length}}: {{timer.convertTime(timer.timeKeeper[step.id.toString()].current)}}/{{timer.convertTime(step.step_duration)}}</li>
                    }
                  }
                </ul>
              </div>
            }

          }
        </div>
      </div>
    }

    <div class="d-flex flex-column border-black w-100 overflow-auto" style="height: 86vh; position:relative">
      <div class="container-fluid p-2 d-flex flex-column">
        <nav class="navbar navbar-expand-lg bg-body-tertiary">
          <div class="container-fluid d-flex flex-row justify-content-between">
            <div>
              <button class="btn btn-light" (click)="showSection=!showSection"><i class="bi bi-menu-app"></i></button>
            </div>
            @if (currentSection) {
              <a class="navbar-brand">{{currentSection.data.section_description}}</a>
            } @else {
              <a class="navbar-brand">Select a Section</a>
            }

            @if (currentStep) {
              @if(timer.timeKeeper[currentStep.id.toString()]){
                <div class="d-flex flex-row justify-content-end gap-2">
                  @if (recording) {
                    <button class="btn btn-outline-danger" (click)="stopRecording()"><i class="bi bi-stop"></i></button>
                  } @else {
                    <button class="btn btn-outline-danger" (click)="clickedElement='Audio';startRecording(true, false)"><i class="bi bi-record"></i></button>
                  }
                  <button class="btn btn-outline-primary">{{timer.convertTime(timer.timeKeeper[currentStep.id.toString()].current)}}</button>
                  @if (timer.timeKeeper[currentStep.id.toString()].started) {
                    <button class="btn btn-outline-primary" (click)="pauseTimer(currentStep.id)"><i class="bi bi-pause"></i></button>
                  } @else {
                    <button class="btn btn-outline-primary" (click)="startTimer(currentStep.id)"><i class="bi bi-play"></i></button>
                  }
                  <button class="btn btn-outline-primary" (click)="resetTimer(currentStep.id)"><i class="bi bi-arrow-counterclockwise"></i></button>
                </div>
              }
            }
          </div>
        </nav>
        @if (currentStep) {
          <div class="d-flex flex-row justify-content-between">
            @if (getPreviousStep() !== '') {
              <a class="btn border-0" (click)="goToPrevious()">Previous <i>{{getPreviousStep()}}...</i></a>
            } @else {
              <a class="btn border-0" disabled>No previous step.</a>
            }
            @if (currentStep.next_step.length === 0) {
              <a class="btn border-0" disabled>Finish, no next step.</a>
            } @else {
              <a class="btn border-0" (click)="goToNext()"><i>{{getNextStep()}}...</i> Next</a>
            }
          </div>
          <div class="container-fluid d-flex flex-column justify-content-center">
            <div [innerHTML]="currentStep.step_description"></div>
            <!--<a class="btn" (click)="viewAnnotationMenu=!viewAnnotationMenu">+ Add Annotation</a>-->
            @if (viewAnnotationMenu) {
<!--              <div class="d-flex flex-wrap gap-2">
                @for (a of ['Audio', 'Text', 'Video', 'Image', 'Sketchpad', 'File']; track a) {
                  <div class="card" >
                    <div class="card-body" (click)="annotationMenuClick(a)" (mouseenter)="mouseOverElement=a" (mouseout)="mouseOverElement=''" [ngClass]="{'bg-info': mouseOverElement==a}">
                      {{a}}
                    </div>
                  </div>
                }
              </div>-->


            }
            <div>
              <button class="btn btn-primary" (click)="getStepSummarySoFar(currentStep)">Summarize previous steps</button>
              @if (dataService.stepCompletionSummary[currentStep.id]){
                @if (!dataService.stepCompletionSummary[currentStep.id].completed) {
                  <div class="loading">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                }
                <div class="alert alert-info">
                  <p>{{dataService.stepCompletionSummary[currentStep.id].content}}</p>
                </div>
              }

            </div>
            <div class="p-2">
              @if (clickedElement==='Text') {
                <app-annotation-text-form (text)="handleTextAnnotation($event)"></app-annotation-text-form>
              } @else if (clickedElement==='Sketchpad') {
                <app-handwritten-annotation (sketch)="handleSketchAnnotation($event)"></app-handwritten-annotation>
              } @else if (clickedElement==='File') {
                <div class="form-group">
                  <label for="file">Upload File</label>
                  <input type="file" class="form-control" id="file" (change)="handleFileInput($event)">
                </div>
              } @else if (clickedElement==='Audio') {
                <div class="d-flex flex-row gap-2">
                  @if (recording) {
                    <button class="btn btn-danger" (click)="stopRecording()">Stop Recording</button>
                  } @else {
                    <button class="btn btn-primary" (click)="startRecording(true, false)">Start Recording</button>
                  }
                  <div class="form-floating">
                    <select class="form-select" [(ngModel)]="currentAudioDevice" >
                      <option selected [value]="null">Default Selected</option>
                      @for (a of audioDevices; track a) {
                        <option [ngValue]="a">{{a.label}}</option>
                      }
                    </select>
                    <label>Select Audio Device</label>
                  </div>
                </div>

              } @else if (clickedElement==='Video') {
                <div class="d-flex flex-row gap-2">
                  @if (recording) {
                    <button class="btn btn-danger" (click)="stopRecording()">Stop Recording</button>
                  } @else {
                    <button class="btn btn-primary" (click)="startRecording(true, true)">Start Recording</button>
                  }
                  <div class="form-floating">
                    <select class="form-select" [(ngModel)]="currentCameraDevice">
                      <option selected>Default Selected</option>
                      @for (a of cameraDevices; track a) {
                        <option [ngValue]="a">{{a.label}}</option>
                      }
                    </select>
                    <label>Select Camera Device</label>
                  </div>
                </div>
                @if (recording) {
                  <div class="d-flex flex-row justify-content-center">
                    <video autoplay muted #previewVideo [width]="400" [height]="300"></video>
                  </div>
                }
              } @else if (clickedElement==='Image') {
                <div class="form-group">
                  <label for="image">Upload Image</label>
                  <input type="file" class="form-control" id="image" (change)="handleFileInput($event)">
                </div>
              }
            </div>
          </div>
        } @else {
          <div class="container-fluid p-2 d-flex flex-column" style="height: 100%">
            <div class="border-dark border-opacity-25 rounded-3 d-flex justify-content-center align-items-center h-100"
                 style="border-style: dashed">
              <div class="p-5">
                <p>
                  No section or step selected yet.
                </p>
              </div>
            </div>
          </div>
        }
        <div class="container-fluid">
          @if (currentStep) {
            <div class="d-flex flex-column g-2">
              @if (audioURL) {
                <div class="d-flex flex-column gap-1">
                  <div class="d-flex flex-row justify-content-center">
                    Recording Preview
                    @if (clickedElement==='Audio') {
                      <audio controls>
                        <source [src]="audioURL" type="audio/webm">
                        Your browser does not support the audio element.
                      </audio>
                    } @else if (clickedElement==='Video') {
                      <video controls [width]="400" [height]="300">
                        <source [src]="audioURL" type="video/webm">
                        Your browser does not support the video element.
                      </video>
                    }
                  </div>
                  <div class="d-flex flex-row gap-2">
                    <button class="btn btn-primary" (click)="saveRecording()">Save</button>
                    <button class="btn btn-danger" (click)="deletePreviewRecording()">Delete</button>
                  </div>
                </div>
              }
            </div>
            @if (annotations) {
              @if (annotations.count > 0) {
                <app-annotation-presenter [annotations]="annotations.results" (deleteAnnotation)="deleteAnnotation($event)"></app-annotation-presenter>
              }
            }
          }
        </div>
      </div>

    </div>
  </div>
</div>

<div style="position: fixed; z-index: 1030; bottom: 50px; right: 50px">
  <div class="d-flex flex-row gap-2 align-items-center">
    @if (annotations) {
      @if (annotations.previous || annotations.next) {
        <span>Annotation Page</span>
        @if (annotations.previous) {
          <button class="btn btn-outline-primary" (click)="previousAnnotationPage()"><i class="bi bi-arrow-left"></i></button>
        }
        @if (annotations.next) {
          <button class="btn btn-outline-primary" (click)="nextAnnotationPage()"><i class="bi bi-arrow-right"></i></button>
        }
      }
    }
    <div ngbDropdown placement="top-end" class="d-inline-block">
      <button class="btn btn-outline-success" ngbDropdownToggle><i class="bi bi-plus"></i></button>
      <div ngbDropdownMenu>
        @for (a of ['Audio', 'Text', 'Video', 'Image', 'Sketchpad', 'File']; track a) {
          <button ngbDropdownItem (click)="annotationMenuClick(a)">{{a}}</button>
        }
      </div>
    </div>

  </div>
</div>

