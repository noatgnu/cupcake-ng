<div class="enhanced-counter-presenter">
  <!-- Voice Recognition Alert -->
  @if (speech.currentAnnotation === annotation.id) {
    <div class="alert alert-info border-0 mb-3">
      <div class="d-flex align-items-center">
        <i class="bi bi-mic text-primary me-2 fs-5"></i>
        <div>
          <strong>Voice Control Active</strong>
          <p class="mb-0 small">Say commands like: "increase by 5", "decrease by 2", "set to 10", or "reset"</p>
        </div>
      </div>
    </div>
  }

  <div class="card counter-card">
    <!-- Enhanced Header -->
    <div class="card-header counter-header">
      <div class="d-flex justify-content-between align-items-center">
        <div class="counter-info">
          <h5 class="card-title mb-1">{{data.name}}</h5>
          <div class="counter-meta">
            <small class="text-muted">
              <i class="bi bi-target me-1"></i>Target: {{data.total}}
              <span class="mx-2">â€¢</span>
              <i class="bi bi-percent me-1"></i>{{getProgressPercentage()}}% Complete
            </small>
          </div>
        </div>
        
        <div class="counter-actions">
          <!-- Settings Dropdown -->
          <div class="btn-group" ngbDropdown container="body">
            <button class="btn btn-outline-secondary btn-sm" ngbDropdownToggle ngbTooltip="Counter Settings">
              <i class="bi bi-gear"></i>
            </button>
            <div class="dropdown-menu" ngbDropdownMenu>
              <h6 class="dropdown-header">Quick Actions</h6>
              <button class="dropdown-item" (click)="resetCounter()">
                <i class="bi bi-arrow-counterclockwise me-2"></i>Reset to 0
              </button>
              <button class="dropdown-item" (click)="setToTarget()">
                <i class="bi bi-bullseye me-2"></i>Set to Target
              </button>
              <div class="dropdown-divider"></div>
              <h6 class="dropdown-header">Increment</h6>
              @for (increment of quickIncrements; track increment) {
                <button class="dropdown-item" (click)="setCustomIncrement(increment)">
                  <i class="bi bi-plus-circle me-2"></i>{{increment}}
                  @if (customIncrement === increment) {
                    <i class="bi bi-check text-success ms-auto"></i>
                  }
                </button>
              }
              <div class="dropdown-divider"></div>
              <button class="dropdown-item" (click)="toggleEditMode()">
                <i class="bi bi-pencil me-2"></i>Edit Values
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card-body counter-body">
      <!-- Progress Visualization -->
      <div class="counter-progress-section mb-4">
        <div class="progress-display">
          <div class="current-value-display">
            <div class="value-circle" [class.completed]="isCompleted()" [class.over-target]="isOverTarget()">
              <div class="value-number">{{data.current}}</div>
              <div class="value-label">Current</div>
            </div>
          </div>
          
          <div class="progress-bar-container">
            <div class="progress-bar-wrapper">
              <div class="progress" [style.height.px]="20">
                <div class="progress-bar progress-bar-striped" 
                     [class.progress-bar-animated]="isCompleted()"
                     [class.bg-success]="isCompleted()"
                     [class.bg-warning]="isOverTarget()"
                     [style.width.%]="Math.min(getProgressPercentage(), 100)"
                     role="progressbar"
                     [attr.aria-valuenow]="data.current"
                     [attr.aria-valuemin]="0"
                     [attr.aria-valuemax]="data.total">
                </div>
              </div>
              <div class="progress-labels">
                <small class="text-muted">0</small>
                <small class="text-primary fw-bold">{{data.total}}</small>
              </div>
            </div>
          </div>
          
          <div class="target-value-display">
            <div class="target-circle">
              <div class="value-number">{{data.total}}</div>
              <div class="value-label">Target</div>
            </div>
          </div>
        </div>
        
        <!-- Status Messages -->
        <div class="counter-status mt-3">
          @if (isCompleted()) {
            <div class="alert alert-success py-2">
              <i class="bi bi-check-circle me-2"></i>Target achieved! Great work!
            </div>
          } @else if (isOverTarget()) {
            <div class="alert alert-warning py-2">
              <i class="bi bi-exclamation-triangle me-2"></i>Over target by {{data.current - data.total}}
            </div>
          } @else {
            <div class="text-center text-muted">
              <small>{{data.total - data.current}} remaining to reach target</small>
            </div>
          }
        </div>
      </div>

      <!-- Counter Controls -->
      <div class="counter-controls">
        <!-- Custom Increment Input -->
        <div class="increment-control mb-3">
          <label class="form-label small text-muted">Increment Amount</label>
          <div class="input-group input-group-sm">
            <button class="btn btn-outline-secondary" 
                    (click)="decrementCustomIncrement()"
                    ngbTooltip="Decrease increment">
              <i class="bi bi-dash"></i>
            </button>
            <input type="number" 
                   class="form-control text-center" 
                   [(ngModel)]="customIncrement"
                   [min]="1" 
                   [max]="100"
                   (change)="validateCustomIncrement()">
            <button class="btn btn-outline-secondary" 
                    (click)="incrementCustomIncrement()"
                    ngbTooltip="Increase increment">
              <i class="bi bi-plus"></i>
            </button>
          </div>
        </div>

        <!-- Main Counter Buttons -->
        <div class="counter-buttons">
          <div class="row g-2">
            <div class="col-6">
              <button class="btn btn-success btn-lg w-100" 
                      (click)="incrementCounter()"
                      [disabled]="!canIncrement()"
                      ngbTooltip="Increase by {{customIncrement}}">
                <i class="bi bi-plus-lg me-2"></i>
                <div class="button-content">
                  <div class="button-action">Add</div>
                  <div class="button-value">+{{customIncrement}}</div>
                </div>
              </button>
            </div>
            <div class="col-6">
              <button class="btn btn-danger btn-lg w-100" 
                      (click)="decrementCounter()"
                      [disabled]="!canDecrement()"
                      ngbTooltip="Decrease by {{customIncrement}}">
                <i class="bi bi-dash-lg me-2"></i>
                <div class="button-content">
                  <div class="button-action">Subtract</div>
                  <div class="button-value">-{{customIncrement}}</div>
                </div>
              </button>
            </div>
          </div>
        </div>

        <!-- Direct Value Input (Edit Mode) -->
        @if (editMode) {
          <div class="direct-input-section mt-3">
            <div class="alert alert-info py-2">
              <i class="bi bi-pencil me-2"></i>Edit mode: directly modify values
            </div>
            
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label small">Current Value</label>
                <div class="input-group">
                  <input type="number" 
                         class="form-control" 
                         [(ngModel)]="editingCurrent"
                         [min]="minValue" 
                         [max]="maxValue">
                  <button class="btn btn-outline-primary" 
                          (click)="applyDirectValue('current')"
                          ngbTooltip="Apply current value">
                    <i class="bi bi-check"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label small">Target Value</label>
                <div class="input-group">
                  <input type="number" 
                         class="form-control" 
                         [(ngModel)]="editingTarget"
                         [min]="1">
                  <button class="btn btn-outline-primary" 
                          (click)="applyDirectValue('target')"
                          ngbTooltip="Apply target value">
                    <i class="bi bi-check"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <div class="text-center mt-2">
              <button class="btn btn-sm btn-outline-secondary" (click)="toggleEditMode()">
                <i class="bi bi-x me-1"></i>Cancel Edit
              </button>
            </div>
          </div>
        }

        <!-- Quick Action Buttons -->
        <div class="quick-actions mt-3">
          <div class="row g-1">
            <div class="col">
              <button class="btn btn-outline-primary btn-sm w-100" 
                      (click)="adjustCounter(1)"
                      ngbTooltip="Add 1">
                +1
              </button>
            </div>
            <div class="col">
              <button class="btn btn-outline-primary btn-sm w-100" 
                      (click)="adjustCounter(5)"
                      ngbTooltip="Add 5">
                +5
              </button>
            </div>
            <div class="col">
              <button class="btn btn-outline-danger btn-sm w-100" 
                      (click)="adjustCounter(-1)"
                      ngbTooltip="Subtract 1">
                -1
              </button>
            </div>
            <div class="col">
              <button class="btn btn-outline-danger btn-sm w-100" 
                      (click)="adjustCounter(-5)"
                      ngbTooltip="Subtract 5">
                -5
              </button>
            </div>
            <div class="col">
              <button class="btn btn-outline-warning btn-sm w-100" 
                      (click)="resetCounter()"
                      ngbTooltip="Reset to 0">
                <i class="bi bi-arrow-counterclockwise"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Footer with Statistics -->
    <div class="card-footer counter-footer">
      <div class="counter-stats">
        <div class="row g-2 text-center">
          <div class="col">
            <div class="stat-item">
              <div class="stat-value">{{getSessionChanges()}}</div>
              <div class="stat-label">Changes</div>
            </div>
          </div>
          <div class="col">
            <div class="stat-item">
              <div class="stat-value">{{getLastChanged()}}</div>
              <div class="stat-label">Last Updated</div>
            </div>
          </div>
          <div class="col">
            <div class="stat-item">
              <div class="stat-value">{{getEfficiency()}}%</div>
              <div class="stat-label">Efficiency</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
